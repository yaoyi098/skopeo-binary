name: Build

on:
  workflow_dispatch:  # 仅保留手动触发功能

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Read Version
        id: version
        run: |
          # 从version.txt读取版本号
          TAG_VERSION=$(cat version.txt | tr -d '\n')
          echo "::group::[INFO] Building version $TAG_VERSION"
          echo "build_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "RELEASE_TAG=$TAG_VERSION" >> $GITHUB_ENV

      - name: Build Skopeo
        env:
          BUILD_VERSION: ${{ steps.version.outputs.build_version }}
        run: |
          set -eux
          APP_REPO=https://github.com/containers/skopeo.git
          
          # 克隆指定版本的代码
          git clone --depth 1 --branch $BUILD_VERSION $APP_REPO skopeo-src
          cd skopeo-src

          build_image="golang:1.23-alpine"
          docker pull "${build_image}"

          # Linux 构建
          docker run --rm -t -v $PWD:/build "${build_image}" sh -c "apk update && apk add gpgme-dev btrfs-progs-dev llvm15-dev gcc musl-dev && cd /build && CGO_ENABLE=0 GO111MODULE=on GOOS=linux GOARCH=amd64 go build -mod=vendor -ldflags='-s -w' -tags 'exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp' -o ./bin/skopeo-linux-amd64 ./cmd/skopeo"
          docker run --rm -t -v $PWD:/build "${build_image}" sh -c "cd /build && CGO_ENABLE=0 GO111MODULE=on GOOS=linux GOARCH=arm64 go build -mod=vendor -ldflags='-s -w' -tags 'exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp' -o ./bin/skopeo-linux-arm64 ./cmd/skopeo"
          docker run --rm -t -v $PWD:/build "${build_image}" sh -c "cd /build && CGO_ENABLE=0 GO111MODULE=on GOOS=linux GOARCH=ppc64le go build -mod=vendor -ldflags='-s -w' -tags 'exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp' -o ./bin/skopeo-linux-ppc64le ./cmd/skopeo"
          
          # Darwin 构建
          docker run --rm -t -v $PWD:/build "${build_image}" sh -c "cd /build && CGO_ENABLE=0 GO111MODULE=on GOOS=darwin GOARCH=amd64 go build -mod=vendor -ldflags='-s -w' -tags 'exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp' -o ./bin/skopeo-darwin-amd64 ./cmd/skopeo"
          docker run --rm -t -v $PWD:/build "${build_image}" sh -c "cd /build && CGO_ENABLE=0 GO111MODULE=on GOOS=darwin GOARCH=arm64 go build -mod=vendor -ldflags='-s -w' -tags 'exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp' -o ./bin/skopeo-darwin-arm64 ./cmd/skopeo"
          
          # 生成校验文件
          cd bin
          for binary in *; do
            md5sum "${binary}" > "${binary}.md5"
            sha256sum "${binary}" > "${binary}.sha256"
          done
          echo "::endgroup::"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}  # 使用从version.txt获取的版本
          name: Skopeo ${{ env.RELEASE_TAGE }} Release
          files: |
            skopeo-src/bin/*
          body: "Automated build for Skopeo ${{ env.RELEASE_TAG }}"
