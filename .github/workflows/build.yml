name: Build

on:
  push:
    tags:
      - 'v*'   # 匹配所有以v开头的标签（如v1.2.3）
  workflow_dispatch:  # 保留手动触发功能

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 获取所有历史记录以便获取标签信息

      - name: Setup Build Environment
        id: setup
        run: |
          # 直接使用推送的标签作为版本号
          TAG_VERSION="${GITHUB_REF#refs/tags/}"
          echo "::group::[INFO] Building version $TAG_VERSION"
          echo "build_version=${TAG_VERSION}" >> $GITHUB_OUTPUT
          echo "APP_REPO=https://github.com/containers/skopeo.git" >> $GITHUB_ENV

      - name: Build Skopeo
        env:
          BUILD_VERSION: ${{ steps.setup.outputs.build_version }}
        run: |
          set -eux
          # 使用预定义的环境变量
          APP_REPO=${{ env.APP_REPO }}
          
          # 克隆指定版本的代码
          git clone --depth 1 --branch $BUILD_VERSION $APP_REPO skopeo-src
          cd skopeo-src

          # 使用容器构建
          build_image="golang:1.23-alpine"
          docker pull "${build_image}"

          # Linux 构建
          docker run --rm -t -v $PWD:/build "${build_image}" sh -c "apk update && apk add gpgme-dev btrfs-progs-dev llvm15-dev gcc musl-dev && cd /build && CGO_ENABLE=0 GO111MODULE=on GOOS=linux GOARCH=amd64 go build -mod=vendor -ldflags='-s -w' -tags 'exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp' -o ./bin/skopeo-linux-amd64 ./cmd/skopeo"
          docker run --rm -t -v $PWD:/build "${build_image}" sh -c "cd /build && CGO_ENABLE=0 GO111MODULE=on GOOS=linux GOARCH=arm64 go build -mod=vendor -ldflags='-s -w' -tags 'exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp' -o ./bin/skopeo-linux-arm64 ./cmd/skopeo"
          docker run --rm -t -v $PWD:/build "${build_image}" sh -c "cd /build && CGO_ENABLE=0 GO111MODULE=on GOOS=linux GOARCH=ppc64le go build -mod=vendor -ldflags='-s -w' -tags 'exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp' -o ./bin/skopeo-linux-ppc64le ./cmd/skopeo"
          
          # Darwin 构建
          docker run --rm -t -v $PWD:/build "${build_image}" sh -c "cd /build && CGO_ENABLE=0 GO111MODULE=on GOOS=darwin GOARCH=amd64 go build -mod=vendor -ldflags='-s -w' -tags 'exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp' -o ./bin/skopeo-darwin-amd64 ./cmd/skopeo"
          docker run --rm -t -v $PWD:/build "${build_image}" sh -c "cd /build && CGO_ENABLE=0 GO111MODULE=on GOOS=darwin GOARCH=arm64 go build -mod=vendor -ldflags='-s -w' -tags 'exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp' -o ./bin/skopeo-darwin-arm64 ./cmd/skopeo"
          
          # 生成校验文件
          cd bin
          for binary in *; do
            md5sum "${binary}" > "${binary}.md5"
            sha256sum "${binary}" > "${binary}.sha256"
          done
          echo "::endgroup::"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}  # 直接使用推送的标签
          files: |
            skopeo-src/bin/*
          body: "Automated build for Skopeo ${{ github.ref_name }}"
